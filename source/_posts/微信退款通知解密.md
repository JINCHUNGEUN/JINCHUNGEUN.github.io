---
title: Python实现微信支付退款结果解密
date: 2020-04-02 15:05:33
tags:
---


## 1. 概念
高级加密技术（缩写：AES），是一种对称秘钥机密中最流行的算法之一。
有以下几种模式：
- ECB(Electronic codebook 电子密码本模式)
- CBC(Cipher-block chaining 密码分组模式)
- CFB(Cipher Feedback 密码反馈模式)
- OFB(Output Feedback 输出反馈模式)


## 2. 实现

解密步骤如下：
1. 对加密串做base64解码，得到加密串B
2. 对商户key做md5，得到32位小写key
3. 用key对加密串B做AES-256-ECB解密(使用PKCS7Padding填充算法)

<em>PKCS7填充简单来说就是缺几位补几位，填充的字符为填充长度数字对应的unicode字符，比如要填充8个字符，则填充的字符为0x08。 如果文本长度正好是BlockSize的长度，也会填充BlockSize的长度</em>


```
import base64
import hashlib
from Crypto.Cipher import AES


class AESCryptor:
    KEY = 'somekey'
    BS = 16

    @classmethod
    def _pad(cls, string):
        """
        Pad an input string according to PKCS7
        """
        return string + (cls.BS - len(string) % cls.BS)*(chr(cls.BS - len(string)%cls.BS))

    @classmethod
    def _unpad(cls, string):
        """
        Remove the PKCS7 padding from string
        """
        pad_len = ord(string[-1])
        return string[0:-pad_len]

    @classmethod
    def encrypt(cls, text):
        cipher = AES.new(cls.KEY.encode(), AES.MODE_ECB)
        enc_data = cipher.encrypt(cls._pad(text))
        return enc_data

    @classmethod
    def decrypt(cls, req_info):
        # base64 解密加密串
        req_info = base64.b64decode(req_info)
        # 对商户key做md5
        key = hashlib.md5(cls.KEY.encode()).hexdigest().lower()
        cipher = AES.new(key.encode(), AES.MODE_ECB)
        dec_data = cipher.decrypt(enc_text)
        dec_data = cls._unpad(dec_data).decode()
        return dec_data

```

## Reference
- https://gist.github.com/marcoslin/8026990